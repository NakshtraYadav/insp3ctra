{% extends "layout.html" %}

{% block title %}insp3ctra Dashboard{% endblock %}

{% block scripts %}
<script>
  async function exportPcap() {
  const progress = document.getElementById("export-progress");
  const bar = document.getElementById("progress-bar");
  const status = document.getElementById("export-status");

  progress.style.display = "block";
  bar.style.width = "0%";
  status.textContent = "Exporting...";

  // Simulate progress animation
  let percent = 0;
  const interval = setInterval(() => {
    if (percent < 90) {
      percent += 5;
      bar.style.width = percent + "%";
    }
  }, 100);

  try {
    const res = await fetch("/export_pcap");
    clearInterval(interval);
    bar.style.width = "100%";
    status.textContent = res.ok ? "âœ… Export completed!" : "âŒ Export failed";

    if (res.ok) {
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "insp3ctra_capture.pcap";
      a.click();
    }
  } catch (err) {
    clearInterval(interval);
    status.textContent = "ğŸ”¥ Error during export";
  }
}

  async function stopCapture() {
    await fetch('/stop', { method: 'POST' });
    updateStatus();
  }

  async function updateStatus() {
    const res = await fetch('/status');
    const json = await res.json();
    document.getElementById("status").innerText = json.sniffing ? "ğŸŸ¢ Running" : "ğŸ”´ Stopped";
  }

  async function clearLogs() {
    const res = await fetch('/clear_logs', { method: 'POST' });
    const json = await res.json();
    alert("ğŸ“ " + json.status);
  }

  async function runCommand() {
    const input = document.getElementById("cmdInput").value;
    const output = document.getElementById("terminal-output");
    output.innerText = "âŒ› Running: " + input + "\n" + output.innerText;

    try {
      const res = await fetch("/run_command", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ command: input })
      });

      const json = await res.json();
      const result = (json.error ? "âŒ " : "âœ”ï¸ ") + json.output;
      output.innerText = result + "\n" + output.innerText;
    } catch (e) {
      output.innerText = "ğŸ”¥ Terminal error: " + e.message + "\n" + output.innerText;
    }
  }

async function updateAnomalyLog() {
  console.log("ğŸ” Polling /anomaly_log...");

  try {
    const res = await fetch("/anomaly_log");
    const data = await res.json();
    const logDiv = document.getElementById("anomaly-log");

    logDiv.innerHTML = ""; // âœ… clear the container

    if (data.log && Array.isArray(data.log)) {
      data.log.forEach(line => {
        const div = document.createElement("div");
        div.textContent = line;
        div.style.fontWeight = "bold";
        div.style.color = "#ff4d4d";
        logDiv.appendChild(div);
      });
    }
  } catch (err) {
    console.error("âŒ Failed to fetch anomaly log:", err);
  }
}

window.onload = () => {
  updateStatus();
  updateAnomalyLog();
  setInterval(updateStatus, 2000);
  setInterval(updateAnomalyLog, 2000); // ğŸ” poll anomaly log
};





</script>
{% endblock %}

{% block content %}
  <div class="section">
    {% include "components/status_panel.html" %}
  </div>

  <div class="section">
    {% include "components/interface_selector.html" %}
    {% include "components/control_buttons.html" %}
  </div>

  <div class="section">
    {% include "components/terminal_block.html" %}
  </div>

  <div class="section">
    <h3>ğŸ§¨ Anomaly Alerts</h3>
    <div id="anomaly-log" style="background: #111; color: #ff4d4d; padding: 10px; font-family: monospace; font-size: 14px; height: 150px; overflow-y: auto; border: 1px solid #444;">
      <!-- Logs will be inserted here -->
    </div>
  </div>
{% endblock %}
