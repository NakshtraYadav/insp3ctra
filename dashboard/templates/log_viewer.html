{% extends "layout.html" %}

{% block title %}insp3ctra Log Viewer{% endblock %}

{% block content %}
<div class="section">
  <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">ðŸ“„ insp3ctra Log Viewer</h2>
  <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
    <div>
      <label style="margin-right: 0.5rem;">
        <input type="radio" name="filetype" value="csv" checked> CSV
      </label>
      <label>
        <input type="radio" name="filetype" value="json"> JSON
      </label>
    </div>
    <button onclick="fetchAndDisplay()">Load Logs</button>
  </div>

  <div style="margin-bottom: 1.25rem;">
    <label for="filterField"><strong>Filter by:</strong></label>
    <select id="filterField" style="margin: 0 0.5rem; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #cbd5e1;">
      <option value="1">Source IP</option>
      <option value="2">Destination IP</option>
      <option value="3">Protocol</option>
      <option value="4">Summary</option>
    </select>
    <input type="text" id="filterValue" placeholder="Enter filter text..." style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-family: monospace; width: 50%;">
    <button onclick="applyFilter()">Apply Filter</button>
  </div>

  <div style="overflow-x: auto;">
    <table id="logTable" style="width: 100%; border-collapse: collapse;">
      <thead style="background-color: #f8fafc;">
        <tr>
          <th style="padding: 0.75rem; border-bottom: 2px solid #e2e8f0; text-align: left;">Source</th>
          <th style="padding: 0.75rem; border-bottom: 2px solid #e2e8f0; text-align: left;">Destination</th>
          <th style="padding: 0.75rem; border-bottom: 2px solid #e2e8f0; text-align: left;">Protocol</th>
          <th style="padding: 0.75rem; border-bottom: 2px solid #e2e8f0; text-align: left;">Summary</th>
        </tr>
      </thead>
      <tbody style="background-color: white;"></tbody>
    </table>
  </div>
</div>

<script>
  async function fetchAndDisplay() {
    const fileType = document.querySelector('input[name="filetype"]:checked').value;
    const response = await fetch(`/get_log_data?type=${fileType}`);
    const data = await response.json();
    const table = document.getElementById("logTable");
    const tbody = table.querySelector("tbody");
    tbody.innerHTML = "";

    for (const row of data) {
      const tr = document.createElement("tr");
      ["src", "dst", "proto", "summary"].forEach(field => {
        const td = document.createElement("td");
        td.textContent = row[field] || "-";
        td.style.padding = "0.6rem";
        td.style.borderBottom = "1px solid #e2e8f0";
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }
  }

  function applyFilter() {
    const filterValue = document.getElementById("filterValue").value.toLowerCase();
    const filterField = document.getElementById("filterField").value;
    const rows = document.querySelectorAll("#logTable tbody tr");

    rows.forEach(row => {
      const cell = row.querySelector(`td:nth-child(${filterField})`);
      row.style.display = cell && cell.textContent.toLowerCase().includes(filterValue) ? "" : "none";
    });
  }

  window.onload = fetchAndDisplay;
</script>
{% endblock %}